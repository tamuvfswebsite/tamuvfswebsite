<%= form_with(model: role_application) do |form| %>
  <% if role_application.errors.any? %>
    <div style="color: red; background-color: #ffebee; border: 1px solid red; padding: 10px; margin-bottom: 15px;">
      <h3><%= pluralize(role_application.errors.count, "error") %> prohibited your application from being submitted:</h3>

      <ul>
        <% role_application.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div style="margin-bottom: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
    <i style="margin: 0; color: #856404;">
      We highly recommend writing your free response answers in a separate document first then
      pasting them here to account for potential technical issues.
    </i>
  </div>

  <div style="margin-bottom: 20px;">
    <h3>Your Resume</h3>
    <% if current_user.resume&.file&.attached? %>
      <p>Resume uploaded: <%= link_to current_user.resume.file.filename, user_resume_path(current_user), target: "_blank" %></p>
      <% 
        # Determine the return path based on whether we're editing or creating
        return_param = role_application.persisted? ? "application_edit_#{role_application.id}" : 'application'
      %>
      <%= link_to "Edit Resume", edit_user_resume_path(current_user, return_to: return_param), class: "btn btn-secondary", style: "display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 4px;" %>
    <% else %>
      <p style="color: red;">No resume uploaded. Please upload your resume before submitting.</p>
      <% 
        # Determine the return path based on whether we're editing or creating
        return_param = role_application.persisted? ? "application_edit_#{role_application.id}" : 'application'
      %>
      <%= link_to "Upload Resume", new_user_resume_path(current_user, return_to: return_param), class: "btn btn-primary", style: "display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px;" %>
    <% end %>
  </div>

  <div style="margin-bottom: 15px;">
    <%= form.label :org_role_id, "Select VFS Role", style: "display: block; font-weight: bold; margin-bottom: 5px;" %>
    <%= form.collection_select :org_role_id, @organizational_roles, :id, :name, { prompt: "Choose a role to apply for..." }, { style: "width: 100%; padding: 8px; font-size: 14px;", id: "role_application_org_role_id" } %>
  </div>

  <div id="application-questions" style="margin-bottom: 15px;">
    <!-- Questions will be dynamically displayed here based on selected role -->
    <% if role_application.organizational_role.present? %>
      <% if role_application.organizational_role.question_1.present? %>
        <div class="question-field" style="margin-bottom: 15px;">
          <%= form.label :answer_1, role_application.organizational_role.question_1 + " (Minimum 50 characters)", style: "display: block; font-weight: bold; margin-bottom: 5px;" %>
          <%= form.text_area :answer_1, rows: 10, placeholder: "Your answer here...", style: "width: 100%; padding: 8px; font-size: 14px; font-family: inherit;" %>
        </div>
      <% end %>

      <% if role_application.organizational_role.question_2.present? %>
        <div class="question-field" style="margin-bottom: 15px;">
          <%= form.label :answer_2, role_application.organizational_role.question_2 + " (Minimum 50 characters)", style: "display: block; font-weight: bold; margin-bottom: 5px;" %>
          <%= form.text_area :answer_2, rows: 10, placeholder: "Your answer here...", style: "width: 100%; padding: 8px; font-size: 14px; font-family: inherit;" %>
        </div>
      <% end %>

      <% if role_application.organizational_role.question_3.present? %>
        <div class="question-field" style="margin-bottom: 15px;">
          <%= form.label :answer_3, role_application.organizational_role.question_3 + " (Minimum 50 characters)", style: "display: block; font-weight: bold; margin-bottom: 5px;" %>
          <%= form.text_area :answer_3, rows: 10, placeholder: "Your answer here...", style: "width: 100%; padding: 8px; font-size: 14px; font-family: inherit;" %>
        </div>
      <% end %>
    <% else %>
      <p style="color: #666; font-style: italic;">Please select a role to see application questions.</p>
    <% end %>
  </div>

  <!-- Embed organizational roles data for JavaScript -->
  <script id="organizational-roles-data" type="application/json">
    <%= raw @organizational_roles.to_json(only: [:id, :name, :question_1, :question_2, :question_3]) %>
  </script>

  <div>
    <%= form.submit "Submit Application", class: "btn btn-primary", style: "padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;" %>
  </div>
<% end %>

<script>
function initializeRoleQuestions() {
  const roleSelect = document.getElementById('role_application_org_role_id');
  const questionsContainer = document.getElementById('application-questions');
  const rolesDataElement = document.getElementById('organizational-roles-data');
  
  if (!roleSelect || !questionsContainer || !rolesDataElement) {
    return;
  }
  
  const organizationalRoles = JSON.parse(rolesDataElement.textContent);
  
  function updateQuestions() {
    const selectedRoleId = parseInt(roleSelect.value);
    const selectedRole = organizationalRoles.find(role => role.id === selectedRoleId);
    
    if (!selectedRole) {
      questionsContainer.innerHTML = '<p style="color: #666; font-style: italic;">Please select a role to see application questions.</p>';
      return;
    }
    
    // Preserve existing values before replacing HTML
    const existingAnswer1 = document.getElementById('role_application_answer_1')?.value || '';
    const existingAnswer2 = document.getElementById('role_application_answer_2')?.value || '';
    const existingAnswer3 = document.getElementById('role_application_answer_3')?.value || '';
    
    let questionsHTML = '';
    
    if (selectedRole.question_1) {
      questionsHTML += `
        <div class="question-field" style="margin-bottom: 15px;">
          <label for="role_application_answer_1" style="display: block; font-weight: bold; margin-bottom: 5px;">
            ${selectedRole.question_1} (Minimum 50 characters)
          </label>
          <textarea name="role_application[answer_1]" id="role_application_answer_1" rows="10" 
                    placeholder="Your answer here..." 
                    style="width: 100%; padding: 8px; font-size: 14px; font-family: inherit;">${existingAnswer1}</textarea>
        </div>
      `;
    }
    
    if (selectedRole.question_2) {
      questionsHTML += `
        <div class="question-field" style="margin-bottom: 15px;">
          <label for="role_application_answer_2" style="display: block; font-weight: bold; margin-bottom: 5px;">
            ${selectedRole.question_2} (Minimum 50 characters)
          </label>
          <textarea name="role_application[answer_2]" id="role_application_answer_2" rows="10" 
                    placeholder="Your answer here..." 
                    style="width: 100%; padding: 8px; font-size: 14px; font-family: inherit;">${existingAnswer2}</textarea>
        </div>
      `;
    }
    
    if (selectedRole.question_3) {
      questionsHTML += `
        <div class="question-field" style="margin-bottom: 15px;">
          <label for="role_application_answer_3" style="display: block; font-weight: bold; margin-bottom: 5px;">
            ${selectedRole.question_3} (Minimum 50 characters)
          </label>
          <textarea name="role_application[answer_3]" id="role_application_answer_3" rows="10" 
                    placeholder="Your answer here..." 
                    style="width: 100%; padding: 8px; font-size: 14px; font-family: inherit;">${existingAnswer3}</textarea>
        </div>
      `;
    }
    
    if (!questionsHTML) {
      questionsHTML = '<p style="color: #666; font-style: italic;">This role has no application questions. You may submit your application.</p>';
    }
    
    questionsContainer.innerHTML = questionsHTML;
  }
  
  // Attach the change event listener
  roleSelect.addEventListener('change', updateQuestions);
  
  // Trigger immediately if a role is already selected
  if (roleSelect.value) {
    updateQuestions();
  }
}

// Support both regular page loads and Turbo navigation
document.addEventListener('DOMContentLoaded', initializeRoleQuestions);
document.addEventListener('turbo:load', initializeRoleQuestions);
</script>